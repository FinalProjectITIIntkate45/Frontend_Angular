<!-- auctions-list.component.html -->

<!-- Eco-Industrial Auctions List -->
<div class="container py-4">
  <!-- Header -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="d-flex align-items-center justify-content-between bg-steel text-white rounded shadow-sm p-3">
        <h2 class="mb-0 fw-bold text-uppercase">
          <i class="fas fa-recycle me-2 text-rust"></i> Auctions
        </h2>
      </div>
    </div>
  </div>

  <!-- Filter Toolbar -->
  <form [formGroup]="filterForm" class="row g-3 align-items-end mb-4 bg-earth rounded p-3 shadow-sm">
    <div class="col-auto">
      <label for="citySelect" class="form-label fw-bold mb-0 text-steel">City</label>
      <select id="citySelect" class="form-select" formControlName="city">
        <option value="">-- Choose City --</option>
        <option *ngFor="let city of cities" [value]="city">{{ city }}</option>
      </select>
    </div>
    <div class="col-auto">
      <button type="button" class="btn btn-green" (click)="onSearch()" [disabled]="isLoading">
        <i class="fas fa-search me-1"></i> Search
      </button>
    </div>
  </form>

  <!-- Alerts -->
  <div class="row mb-3">
    <div class="col-12">
      <div *ngIf="errorMessage" class="alert alert-danger d-flex align-items-center" role="alert">
        <i class="fas fa-exclamation-triangle me-2"></i> {{ errorMessage }}
        <button type="button" class="btn-close ms-auto" (click)="clearMessages()" aria-label="Close"></button>
      </div>
      <div *ngIf="successMessage" class="alert alert-success d-flex align-items-center" role="alert">
        <i class="fas fa-check-circle me-2"></i> {{ successMessage }}
        <button type="button" class="btn-close ms-auto" (click)="clearMessages()" aria-label="Close"></button>
      </div>
    </div>
  </div>

  <!-- Loading Spinner -->
  <div *ngIf="isLoading" class="d-flex flex-column align-items-center py-5">
    <div class="spinner-border text-green" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
    <p class="mt-3 text-steel">Loading auctions...</p>
  </div>

  <!-- Auctions Grid -->
  <div *ngIf="!isLoading">
    <div *ngIf="auctions.length === 0" class="text-center py-5 text-steel">
      <i class="fas fa-inbox fa-3x mb-3 text-earth"></i>
      <h4>No Auctions Found</h4>
      <p>No auctions are currently available for the selected city. Try a different city or check back later.</p>
    </div>
    <div class="row g-4" *ngIf="auctions.length > 0">
      <div *ngFor="let auction of auctions; trackBy: trackByAuctionId" class="col-12 col-md-6 col-lg-4">
        <div class="card h-100 shadow-sm border-steel bg-earth">
          <div class="card-header bg-steel text-white d-flex align-items-center">
            <i class="fas fa-recycle me-2 text-rust"></i>
            <span class="fw-bold">{{ auction.Matrialname }}</span>
            <span class="badge ms-auto" [class]="getStatusBadgeClass(auction.Status)">
              {{ getStatusText(auction.Status) }}
            </span>
          </div>
          <div class="card-body">
            <h5 class="card-title fw-bold text-steel">{{ auction.Matrialname }} <small class="text-muted">- {{ auction.GovernorateName }}</small></h5>
            <ul class="list-unstyled mb-3">
              <li><i class="fas fa-clock me-2 text-green"></i> <strong>Start:</strong> {{ formatDate(auction.StartTime) }}</li>
              <li><i class="fas fa-flag-checkered me-2 text-rust"></i> <strong>End:</strong> {{ formatDate(auction.EndTime) }}</li>
              <li><i class="fas fa-calendar-plus me-2 text-steel"></i> <strong>Created:</strong> {{ formatDate(auction.CreatedAt) }}</li>
            </ul>
            <div *ngIf="auction.Status === 1" class="alert alert-warning py-2 px-3 mb-3">
              <i class="fas fa-hourglass-half me-2"></i> <strong>{{ getTimeRemaining(auction.EndTime) }}</strong>
            </div>
            <div class="d-flex gap-2">
              <button *ngIf="canJoinAuction(auction)" type="button" class="btn btn-orange flex-fill" (click)="openJoinModal(auction)" [disabled]="isJoining">
                <i class="fas fa-handshake me-1"></i> Join Auction
              </button>
              <button *ngIf="!canJoinAuction(auction)" type="button" class="btn btn-outline-secondary flex-fill" disabled>
                <i class="fas fa-ban me-1"></i> {{ auction.Status === 2 ? 'Completed' : 'Unavailable' }}
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Pagination -->
  <nav *ngIf="auctions.length > 0" class="d-flex justify-content-center mt-4" aria-label="Auction pages">
    <ul class="pagination">
      <li class="page-item" [class.disabled]="currentPage === 1">
        <button class="page-link" (click)="onPageChange(currentPage - 1)" [disabled]="currentPage === 1" aria-label="Previous page">
          <i class="fas fa-chevron-left"></i>
        </button>
      </li>
      <li class="page-item active">
        <span class="page-link">Page {{ currentPage }}</span>
      </li>
      <li class="page-item" [class.disabled]="currentPage === totalPages">
        <button class="page-link" (click)="onPageChange(currentPage + 1)" [disabled]="currentPage === totalPages" aria-label="Next page">
          <i class="fas fa-chevron-right"></i>
        </button>
      </li>
    </ul>
  </nav>

  <!-- Join Auction Modal -->
  <div *ngIf="showJoinModal" class="modal fade show d-block" tabindex="-1" style="background: rgba(0,0,0,0.5);">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content border-steel bg-earth">
        <div class="modal-header bg-steel text-white">
          <h5 class="modal-title"><i class="fas fa-gavel me-2"></i> Join Auction</h5>
          <button type="button" class="btn-close btn-close-white" (click)="closeJoinModal()" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div *ngIf="selectedAuction">
            <div class="text-center mb-4">
              <i class="fas fa-recycle fa-2x text-green mb-2"></i>
              <h5 class="fw-bold text-steel">{{ selectedAuction.Matrialname }}</h5>
              <p class="text-muted">{{ selectedAuction.GovernorateName }}</p>
            </div>
            
            <!-- Auction Details -->
            <div class="row mb-3">
              <div class="col-6"><strong>Status:</strong> <span [class]="getStatusBadgeClass(selectedAuction.Status)">{{ getStatusText(selectedAuction.Status) }}</span></div>
              <div class="col-6"><strong>End Date:</strong> {{ formatDate(selectedAuction.EndTime) }}</div>
            </div>
            
            <div *ngIf="selectedAuction.Status === 2" class="alert alert-warning py-2 px-3 mb-3">
              <i class="fas fa-hourglass-half me-2"></i> <strong>{{ getTimeRemaining(selectedAuction.EndTime) }}</strong>
            </div>
            
            <!-- Wallet Information -->
            <div class="card bg-light border-steel mb-3">
              <div class="card-header bg-steel text-white py-2">
                <h6 class="mb-0"><i class="fas fa-wallet me-2"></i> Wallet Information</h6>
              </div>
              <div class="card-body py-2">
                <div *ngIf="isLoadingWallet" class="text-center">
                  <div class="spinner-border spinner-border-sm text-green" role="status"></div>
                  <small class="text-muted">Loading wallet...</small>
                </div>
                <div *ngIf="!isLoadingWallet && userWallet" class="row">
                  <div class="col-6">
                    <small class="text-muted">Points Balance:</small><br>
                    <strong class="text-steel">{{ formatPoints(userWallet.BalancePoints) }} pts</strong>
                  </div>
                  <div class="col-6">
                    <small class="text-muted">Cash Balance:</small><br>
                    <strong class="text-steel">{{ formatCurrency(userWallet.Balancecash) }}</strong>
                  </div>
                </div>
                <div *ngIf="!isLoadingWallet && !userWallet" class="text-center">
                  <small class="text-danger">Unable to load wallet information</small>
                </div>
              </div>
            </div>
            
            <!-- Insurance Information -->
            <div class="alert" [class]="hasSufficientBalance() ? 'alert-info' : 'alert-danger'">
              <div class="d-flex align-items-center">
                <i class="fas fa-shield-alt me-2"></i>
                <div>
                  <strong>Insurance Cost:</strong> {{ getInsuranceCost() }} points
                  <div *ngIf="!hasSufficientBalance() && userWallet" class="small mt-1">
                    <strong class="text-danger">Insufficient balance!</strong> You need {{ getInsuranceCost() - userWallet.BalancePoints }} more points.
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" (click)="closeJoinModal()">Cancel</button>
          <button type="button" class="btn btn-green" (click)="joinAuction()" 
                  [disabled]="isJoining || !hasSufficientBalance()">
            <i class="fas fa-sign-in-alt me-1"></i> 
            {{ isJoining ? 'Processing...' : 'Join Auction & Pay Insurance' }}
          </button>
        </div>
      </div>
    </div>
  </div>
</div>